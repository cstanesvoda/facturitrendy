<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - Trendyol Order Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">User Management</span>
            <div class="d-flex">
                <a href="{{ url_for('logout') }}" class="btn btn-outline-light">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <ul class="nav nav-tabs mb-4" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">
                    Users
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="invoices-tab" data-bs-toggle="tab" data-bs-target="#invoices" type="button" role="tab">
                    Invoices
                </button>
            </li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="users" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Users</h2>
                    <a href="{{ url_for('admin_add_user') }}" class="btn btn-success">Add New User</a>
                </div>

                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Username</th>
                                <th>Role</th>
                                <th>Trendyol Configured</th>
                                <th>SmartBill Configured</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr>
                                <td>{{ user.id }}</td>
                                <td>{{ user.username }}</td>
                                <td>
                                    {% if user.role == 'admin' %}
                                        <span class="badge bg-danger">Admin</span>
                                    {% else %}
                                        <span class="badge bg-primary">User</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if user.trendyol_api_key and user.trendyol_api_secret and user.trendyol_supplier_id %}
                                        <span class="badge bg-success">Yes</span>
                                    {% else %}
                                        <span class="badge bg-secondary">No</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if user.smartbill_api_token and user.smartbill_email and user.smartbill_company_cif %}
                                        <span class="badge bg-success">Yes</span>
                                    {% else %}
                                        <span class="badge bg-secondary">No</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="{{ url_for('admin_edit_user', user_id=user.id) }}" class="btn btn-outline-primary">Edit</a>
                                        {% if user.id != current_user.id %}
                                        <form method="POST" action="{{ url_for('admin_delete_user', user_id=user.id) }}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete user {{ user.username }}?');">
                                            <button type="submit" class="btn btn-outline-danger">Delete</button>
                                        </form>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane fade" id="invoices" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Invoice Records</h2>
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addInvoiceModal">Add Invoice</button>
                </div>

                <div class="mb-3">
                    <div class="input-group">
                        <input type="text" id="invoiceSearch" class="form-control" placeholder="Search by Order ID, Series, or Number...">
                        <button class="btn btn-outline-secondary" type="button" id="searchBtn">Search</button>
                        <button class="btn btn-outline-secondary" type="button" id="clearSearchBtn">Clear</button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>User</th>
                                <th>Order ID</th>
                                <th>Series</th>
                                <th>Number</th>
                                <th>Created At</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="invoicesTableBody">
                            <tr>
                                <td colspan="7" class="text-center">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addInvoiceModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Invoice</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addInvoiceForm">
                        <div class="mb-3">
                            <label class="form-label">Order ID</label>
                            <input type="text" class="form-control" id="addOrderId" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Series</label>
                            <input type="text" class="form-control" id="addSeries" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Number</label>
                            <input type="text" class="form-control" id="addNumber" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="saveAddBtn">Add Invoice</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editInvoiceModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Invoice</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editInvoiceForm">
                        <input type="hidden" id="editInvoiceId">
                        <div class="mb-3">
                            <label class="form-label">Order ID</label>
                            <input type="text" class="form-control" id="editOrderId" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Series</label>
                            <input type="text" class="form-control" id="editSeries" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Number</label>
                            <input type="text" class="form-control" id="editNumber" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveEditBtn">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        async function loadInvoices(searchTerm = '') {
            try {
                const url = `/admin/invoices/search?q=${encodeURIComponent(searchTerm)}`;
                const response = await fetch(url);
                const data = await response.json();

                const tbody = document.getElementById('invoicesTableBody');
                
                if (data.error) {
                    tbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">${data.error}</td></tr>`;
                    return;
                }

                if (!data.invoices || data.invoices.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center">No invoices found</td></tr>';
                    return;
                }

                tbody.innerHTML = data.invoices.map(inv => `
                    <tr>
                        <td>${inv.id}</td>
                        <td><span class="badge bg-info">${inv.username || 'Unknown'}</span></td>
                        <td><strong>${inv.order_id}</strong></td>
                        <td>${inv.series}</td>
                        <td>${inv.number}</td>
                        <td>${new Date(inv.created_at).toLocaleString()}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editInvoice(${inv.id}, '${inv.order_id}', '${inv.series}', '${inv.number}')">Edit</button>
                                <button class="btn btn-outline-danger" onclick="deleteInvoice(${inv.id}, '${inv.order_id}')">Delete</button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            } catch (err) {
                document.getElementById('invoicesTableBody').innerHTML = 
                    `<tr><td colspan="7" class="text-center text-danger">Error loading invoices: ${err.message}</td></tr>`;
            }
        }

        document.getElementById('invoices-tab').addEventListener('click', function() {
            loadInvoices();
        });

        document.getElementById('searchBtn').addEventListener('click', function() {
            const searchTerm = document.getElementById('invoiceSearch').value;
            loadInvoices(searchTerm);
        });

        document.getElementById('clearSearchBtn').addEventListener('click', function() {
            document.getElementById('invoiceSearch').value = '';
            loadInvoices();
        });

        document.getElementById('invoiceSearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const searchTerm = document.getElementById('invoiceSearch').value;
                loadInvoices(searchTerm);
            }
        });

        document.getElementById('saveAddBtn').addEventListener('click', async function() {
            const orderId = document.getElementById('addOrderId').value.trim();
            const series = document.getElementById('addSeries').value.trim();
            const number = document.getElementById('addNumber').value.trim();

            if (!orderId || !series || !number) {
                alert('All fields are required');
                return;
            }

            try {
                const formData = new FormData();
                formData.append('order_id', orderId);
                formData.append('series', series);
                formData.append('number', number);

                const response = await fetch('/admin/invoices/add', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    alert(result.message || 'Invoice added successfully');
                    bootstrap.Modal.getInstance(document.getElementById('addInvoiceModal')).hide();
                    document.getElementById('addInvoiceForm').reset();
                    loadInvoices();
                } else {
                    alert('Error: ' + (result.error || 'Failed to add invoice'));
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        });

        function editInvoice(id, orderId, series, number) {
            document.getElementById('editInvoiceId').value = id;
            document.getElementById('editOrderId').value = orderId;
            document.getElementById('editSeries').value = series;
            document.getElementById('editNumber').value = number;

            new bootstrap.Modal(document.getElementById('editInvoiceModal')).show();
        }

        document.getElementById('saveEditBtn').addEventListener('click', async function() {
            const id = document.getElementById('editInvoiceId').value;
            const orderId = document.getElementById('editOrderId').value.trim();
            const series = document.getElementById('editSeries').value.trim();
            const number = document.getElementById('editNumber').value.trim();

            if (!orderId || !series || !number) {
                alert('All fields are required');
                return;
            }

            try {
                const formData = new FormData();
                formData.append('order_id', orderId);
                formData.append('series', series);
                formData.append('number', number);

                const response = await fetch(`/admin/invoices/edit/${id}`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    alert(result.message || 'Invoice updated successfully');
                    bootstrap.Modal.getInstance(document.getElementById('editInvoiceModal')).hide();
                    loadInvoices();
                } else {
                    alert('Error: ' + (result.error || 'Failed to update invoice'));
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        });

        async function deleteInvoice(id, orderId) {
            if (!confirm(`Are you sure you want to delete the invoice for order ${orderId}?`)) {
                return;
            }

            try {
                const response = await fetch(`/admin/invoices/delete/${id}`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (response.ok) {
                    alert(result.message || 'Invoice deleted successfully');
                    loadInvoices();
                } else {
                    alert('Error: ' + (result.error || 'Failed to delete invoice'));
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }
    </script>
</body>
</html>
